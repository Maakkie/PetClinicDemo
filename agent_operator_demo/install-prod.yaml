# Copyright 2022 Contrast Security, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
apiVersion: v1
kind: Namespace
metadata:
  labels:
    app.kubernetes.io/part-of: contrast-agent-operator
  name: contrast-agent-operator
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  labels:
    app.kubernetes.io/part-of: contrast-agent-operator
  name: agentconfigurations.agents.contrastsecurity.com
spec:
  group: agents.contrastsecurity.com
  names:
    kind: AgentConfiguration
    listKind: AgentConfigurationList
    plural: agentconfigurations
    singular: agentconfiguration
  scope: Namespaced
  versions:
  - name: v1beta1
    schema:
      openAPIV3Schema:
        properties:
          spec:
            description: Specification of the kubernetes object.
            properties:
              initContainer:
                description: |-
                  Optional spec to apply to the Contrast InitContainer.
                  If not specified, reasonable defaults are used.
                nullable: true
                properties:
                  securityContext:
                    description: |-
                      SecurityContext defines the security options the container should be run with.
                      If set, the fields of SecurityContext override the equivalent fields of
                      PodSecurityContext. More info:
                      https://kubernetes.io/docs/tasks/configure-pod-container/security-context/
                    nullable: true
                    properties:
                      allowPrivilegeEscalation:
                        nullable: true
                        type: boolean
                      capabilities:
                        properties:
                          add:
                            items:
                              type: string
                            type: array
                          drop:
                            items:
                              type: string
                            type: array
                        type: object
                      privileged:
                        nullable: true
                        type: boolean
                      procMount:
                        type: string
                      readOnlyRootFilesystem:
                        nullable: true
                        type: boolean
                      runAsGroup:
                        format: int64
                        nullable: true
                        type: integer
                      runAsNonRoot:
                        nullable: true
                        type: boolean
                      runAsUser:
                        format: int64
                        nullable: true
                        type: integer
                      seLinuxOptions:
                        properties:
                          level:
                            type: string
                          role:
                            type: string
                          type:
                            type: string
                          user:
                            type: string
                        type: object
                      seccompProfile:
                        properties:
                          localhostProfile:
                            type: string
                          type:
                            type: string
                        type: object
                      windowsOptions:
                        properties:
                          gmsaCredentialSpec:
                            type: string
                          gmsaCredentialSpecName:
                            type: string
                          hostProcess:
                            nullable: true
                            type: boolean
                          runAsUserName:
                            type: string
                        type: object
                    type: object
                type: object
              suppressDefaultApplicationName:
                description: |-
                  If false, automatically set the Contrast application name on injected workloads (the workload name),
                  rather than use the default (generated by the agent).
                  Defaults to false.
                nullable: true
                type: boolean
              suppressDefaultServerName:
                description: |-
                  If false, automatically set the Contrast server name on injected workloads ('kubernetes-{namespace}'),
                  rather than use the default (normally the pod name).
                  Defaults to false.
                nullable: true
                type: boolean
              yaml:
                description: The contrast_security.yaml file. Multiple lines are supported.
                nullable: true
                type: string
            type: object
        type: object
    served: true
    storage: true
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  labels:
    app.kubernetes.io/part-of: contrast-agent-operator
  name: agentconnections.agents.contrastsecurity.com
spec:
  group: agents.contrastsecurity.com
  names:
    kind: AgentConnection
    listKind: AgentConnectionList
    plural: agentconnections
    singular: agentconnection
  scope: Namespaced
  versions:
  - name: v1beta1
    schema:
      openAPIV3Schema:
        properties:
          spec:
            description: Specification of the kubernetes object.
            properties:
              apiKey:
                description: The API Key to use for this connection.
                properties:
                  secretKey:
                    description: |-
                      The key in the secret to access the value for. Must exist in the same namespace as the AgentConnection.
                      Required.
                    type: string
                  secretName:
                    description: |-
                      The name of the secret to reference. Must exist in the same namespace as the AgentConnection.
                      Required.
                    type: string
                required:
                - secretName
                - secretKey
                type: object
              serviceKey:
                description: The Service Key to use for this connection.
                properties:
                  secretKey:
                    description: |-
                      The key in the secret to access the value for. Must exist in the same namespace as the AgentConnection.
                      Required.
                    type: string
                  secretName:
                    description: |-
                      The name of the secret to reference. Must exist in the same namespace as the AgentConnection.
                      Required.
                    type: string
                required:
                - secretName
                - secretKey
                type: object
              url:
                description: |-
                  The URL of the Contrast server.
                  Defaults to 'https://app.contrastsecurity.com/Contrast'.
                nullable: true
                type: string
              userName:
                description: The User Name to use for this connection.
                properties:
                  secretKey:
                    description: |-
                      The key in the secret to access the value for. Must exist in the same namespace as the AgentConnection.
                      Required.
                    type: string
                  secretName:
                    description: |-
                      The name of the secret to reference. Must exist in the same namespace as the AgentConnection.
                      Required.
                    type: string
                required:
                - secretName
                - secretKey
                type: object
            required:
            - apiKey
            - serviceKey
            - userName
            type: object
        type: object
    served: true
    storage: true
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  labels:
    app.kubernetes.io/part-of: contrast-agent-operator
  name: agentinjectors.agents.contrastsecurity.com
spec:
  group: agents.contrastsecurity.com
  names:
    kind: AgentInjector
    listKind: AgentInjectorList
    plural: agentinjectors
    singular: agentinjector
  scope: Namespaced
  versions:
  - name: v1beta1
    schema:
      openAPIV3Schema:
        properties:
          spec:
            description: Specification of the kubernetes object.
            properties:
              configuration:
                description: The configuration the injected agent will use.
                nullable: true
                properties:
                  name:
                    description: |-
                      The name of a AgentConfiguration resource. Must exist within the same namespace.
                      Defaults to the AgentConfiguration specified by a ClusterAgentConfiguration.
                    nullable: true
                    type: string
                type: object
              connection:
                description: The connection the injected agent will use to communicate
                  with Contrast.
                nullable: true
                properties:
                  name:
                    description: |-
                      The name of AgentConnection resource. Must exist within the same namespace.
                      Defaults to the AgentConnection specified by a ClusterAgentConnection.
                    nullable: true
                    type: string
                type: object
              enabled:
                description: |-
                  Is this agent injector enabled.
                  Defaults to 'true'.
                type: boolean
              image:
                description: Overrides the default agent images.
                properties:
                  name:
                    description: |-
                      The name of the injector image to use.
                      The default depends on the value of spec.type.
                    nullable: true
                    type: string
                  pullPolicy:
                    description: |-
                      The pull policy to use when fetching Contrast images. See Kubernetes imagePullPolicy for more information.
                      Defaults to "Always".
                    nullable: true
                    pattern: ^(Always|IfNotPresent|Never)$
                    type: string
                  pullSecretName:
                    description: The name of a pull secret to append to the pod's
                      imagePullSecrets list.
                    nullable: true
                    type: string
                  registry:
                    description: |-
                      The fully qualified name of the registry to pull agent images from. This registry must be accessible by the pods being injected and the operator.
                      Defaults to the official Contrast container image registry.
                    nullable: true
                    type: string
                type: object
              selector:
                description: |-
                  Select which Deployment/StatefulSet/DaemonSet pods are eligible for agent injection.
                  Under OpenShift, DeploymentConfig is also supported.
                properties:
                  images:
                    description: |-
                      Container images to inject the agent into. Glob patterns are supported.
                      If empty (the default), selects all containers in Pod.
                    items:
                      type: string
                    type: array
                  labels:
                    description: |-
                      Deployment/StatefulSet/DaemonSet/DeploymentConfig labels whose pods are eligible for agent injection.
                      If empty (the default), selects all workloads in namespace.
                    items:
                      properties:
                        name:
                          description: |-
                            The name of the label to match.
                            Required.
                          type: string
                        value:
                          description: |-
                            The value of the label to match. Glob patterns are supported.
                            Required.
                          type: string
                      required:
                      - name
                      - value
                      type: object
                    type: array
                type: object
              type:
                description: |-
                  The type of agent to inject. Can be one of ['dotnet-core', 'java', 'nodejs', 'nodejs-protect', 'php'].
                  Required.
                pattern: ^(dotnet-core|dotnet|java|node|nodejs|node-protect|nodejs-protect|php|personal-home-page|dummy)$
                type: string
              version:
                description: |-
                  The version of the agent to inject. The literal 'latest' will inject the latest version. Partial version matches are supported, e.g. '2' will select the version '2.1.0'.
                  Defaults to 'latest'.
                nullable: true
                pattern: ^(latest|(\d+(\.\d+){0,3}(-.+)?))$
                type: string
            required:
            - type
            type: object
        type: object
    served: true
    storage: true
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  labels:
    app.kubernetes.io/part-of: contrast-agent-operator
  name: clusteragentconfigurations.agents.contrastsecurity.com
spec:
  group: agents.contrastsecurity.com
  names:
    kind: ClusterAgentConfiguration
    listKind: ClusterAgentConfigurationList
    plural: clusteragentconfigurations
    singular: clusteragentconfiguration
  scope: Namespaced
  versions:
  - name: v1beta1
    schema:
      openAPIV3Schema:
        properties:
          spec:
            description: Specification of the kubernetes object.
            properties:
              namespaces:
                description: |-
                  The namespaces to apply this AgentConfiguration template to. Glob syntax is supported.
                  Optional, defaults to selecting all namespaces.
                items:
                  type: string
                type: array
              template:
                description: |-
                  The default AgentConfiguration to apply to the namespaces selected by 'spec.namespaces'.
                  Required.
                nullable: true
                properties:
                  apiVersion:
                    type: string
                  kind:
                    type: string
                  metadata:
                    description: The metadata of the kubernetes object.
                    type: object
                  spec:
                    description: Specification of the kubernetes object.
                    properties:
                      initContainer:
                        description: |-
                          Optional spec to apply to the Contrast InitContainer.
                          If not specified, reasonable defaults are used.
                        nullable: true
                        properties:
                          securityContext:
                            description: |-
                              SecurityContext defines the security options the container should be run with.
                              If set, the fields of SecurityContext override the equivalent fields of
                              PodSecurityContext. More info:
                              https://kubernetes.io/docs/tasks/configure-pod-container/security-context/
                            nullable: true
                            properties:
                              allowPrivilegeEscalation:
                                nullable: true
                                type: boolean
                              capabilities:
                                properties:
                                  add:
                                    items:
                                      type: string
                                    type: array
                                  drop:
                                    items:
                                      type: string
                                    type: array
                                type: object
                              privileged:
                                nullable: true
                                type: boolean
                              procMount:
                                type: string
                              readOnlyRootFilesystem:
                                nullable: true
                                type: boolean
                              runAsGroup:
                                format: int64
                                nullable: true
                                type: integer
                              runAsNonRoot:
                                nullable: true
                                type: boolean
                              runAsUser:
                                format: int64
                                nullable: true
                                type: integer
                              seLinuxOptions:
                                properties:
                                  level:
                                    type: string
                                  role:
                                    type: string
                                  type:
                                    type: string
                                  user:
                                    type: string
                                type: object
                              seccompProfile:
                                properties:
                                  localhostProfile:
                                    type: string
                                  type:
                                    type: string
                                type: object
                              windowsOptions:
                                properties:
                                  gmsaCredentialSpec:
                                    type: string
                                  gmsaCredentialSpecName:
                                    type: string
                                  hostProcess:
                                    nullable: true
                                    type: boolean
                                  runAsUserName:
                                    type: string
                                type: object
                            type: object
                        type: object
                      suppressDefaultApplicationName:
                        description: |-
                          If false, automatically set the Contrast application name on injected workloads (the workload name),
                          rather than use the default (generated by the agent).
                          Defaults to false.
                        nullable: true
                        type: boolean
                      suppressDefaultServerName:
                        description: |-
                          If false, automatically set the Contrast server name on injected workloads ('kubernetes-{namespace}'),
                          rather than use the default (normally the pod name).
                          Defaults to false.
                        nullable: true
                        type: boolean
                      yaml:
                        description: The contrast_security.yaml file. Multiple lines
                          are supported.
                        nullable: true
                        type: string
                    type: object
                type: object
            required:
            - template
            type: object
        type: object
    served: true
    storage: true
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  labels:
    app.kubernetes.io/part-of: contrast-agent-operator
  name: clusteragentconnections.agents.contrastsecurity.com
spec:
  group: agents.contrastsecurity.com
  names:
    kind: ClusterAgentConnection
    listKind: ClusterAgentConnectionList
    plural: clusteragentconnections
    singular: clusteragentconnection
  scope: Namespaced
  versions:
  - name: v1beta1
    schema:
      openAPIV3Schema:
        properties:
          spec:
            description: Specification of the kubernetes object.
            properties:
              namespaces:
                description: |-
                  The namespaces to apply this AgentConnection template to. Glob syntax is supported.
                  Optional, defaults to selecting all namespaces.
                items:
                  type: string
                type: array
              template:
                description: |-
                  The default AgentConnection to apply to the namespaces selected by 'spec.namespaces'.
                  Required.
                nullable: true
                properties:
                  apiVersion:
                    type: string
                  kind:
                    type: string
                  metadata:
                    description: The metadata of the kubernetes object.
                    type: object
                  spec:
                    description: Specification of the kubernetes object.
                    properties:
                      apiKey:
                        description: The API Key to use for this connection.
                        properties:
                          secretKey:
                            description: |-
                              The key in the secret to access the value for. Must exist in the same namespace as the AgentConnection.
                              Required.
                            type: string
                          secretName:
                            description: |-
                              The name of the secret to reference. Must exist in the same namespace as the AgentConnection.
                              Required.
                            type: string
                        required:
                        - secretName
                        - secretKey
                        type: object
                      serviceKey:
                        description: The Service Key to use for this connection.
                        properties:
                          secretKey:
                            description: |-
                              The key in the secret to access the value for. Must exist in the same namespace as the AgentConnection.
                              Required.
                            type: string
                          secretName:
                            description: |-
                              The name of the secret to reference. Must exist in the same namespace as the AgentConnection.
                              Required.
                            type: string
                        required:
                        - secretName
                        - secretKey
                        type: object
                      url:
                        description: |-
                          The URL of the Contrast server.
                          Defaults to 'https://app.contrastsecurity.com/Contrast'.
                        nullable: true
                        type: string
                      userName:
                        description: The User Name to use for this connection.
                        properties:
                          secretKey:
                            description: |-
                              The key in the secret to access the value for. Must exist in the same namespace as the AgentConnection.
                              Required.
                            type: string
                          secretName:
                            description: |-
                              The name of the secret to reference. Must exist in the same namespace as the AgentConnection.
                              Required.
                            type: string
                        required:
                        - secretName
                        - secretKey
                        type: object
                    required:
                    - apiKey
                    - serviceKey
                    - userName
                    type: object
                type: object
            required:
            - template
            type: object
        type: object
    served: true
    storage: true
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/name: operator
    app.kubernetes.io/part-of: contrast-agent-operator
  name: contrast-agent-operator-service-account
  namespace: contrast-agent-operator
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/name: operator
    app.kubernetes.io/part-of: contrast-agent-operator
  name: contrast-agent-operator-service-role
rules:
- apiGroups:
  - ""
  - agents.contrastsecurity.com
  - coordination.k8s.io
  resources:
  - secrets
  - agentconnections
  - agentconfigurations
  - leases
  verbs:
  - '*'
- apiGroups:
  - admissionregistration.k8s.io
  resources:
  - mutatingwebhookconfigurations
  verbs:
  - create
  - get
  - list
  - watch
  - patch
  - update
  - delete
- apiGroups:
  - apps
  - ""
  - apps.openshift.io
  resources:
  - daemonsets
  - deployments
  - statefulsets
  - pods
  - deploymentconfigs
  verbs:
  - get
  - list
  - watch
  - patch
- apiGroups:
  - agents.contrastsecurity.com
  resources:
  - agentinjectors
  verbs:
  - '*'
- apiGroups:
  - agents.contrastsecurity.com
  - dynatrace.com
  resources:
  - clusteragentconnections
  - dynakubes
  - clusteragentconfigurations
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - get
  - list
  - update
- apiGroups:
  - ""
  - admissionregistration.k8s.io
  resources:
  - services
  - validatingwebhookconfigurations
  verbs:
  - create
  - get
  - patch
  - update
  - delete
- apiGroups:
  - apps
  resources:
  - daemonsets/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - apps
  resources:
  - deployments/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - apps
  resources:
  - statefulsets/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - ""
  resources:
  - pods/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - ""
  resources:
  - services/status
  verbs:
  - get
  - patch
  - update
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/name: operator
    app.kubernetes.io/part-of: contrast-agent-operator
  name: contrast-agent-operator-service-role-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: contrast-agent-operator-service-role
subjects:
- kind: ServiceAccount
  name: contrast-agent-operator-service-account
  namespace: contrast-agent-operator
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/name: operator
    app.kubernetes.io/part-of: contrast-agent-operator
  name: contrast-agent-operator
  namespace: contrast-agent-operator
spec:
  ports:
  - name: https
    port: 443
    targetPort: https
  selector:
    app.kubernetes.io/name: operator
    app.kubernetes.io/part-of: contrast-agent-operator
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/name: operator
    app.kubernetes.io/part-of: contrast-agent-operator
  name: contrast-agent-operator
  namespace: contrast-agent-operator
spec:
  replicas: 1
  revisionHistoryLimit: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: operator
      app.kubernetes.io/part-of: contrast-agent-operator
  template:
    metadata:
      labels:
        app.kubernetes.io/name: operator
        app.kubernetes.io/part-of: contrast-agent-operator
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/os
                operator: In
                values:
                - linux
              - key: kubernetes.io/arch
                operator: In
                values:
                - amd64
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                  - operator
                - key: app.kubernetes.io/part-of
                  operator: In
                  values:
                  - contrast-agent-operator
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: CONTRAST_WEBHOOK_SERVICENAME
          value: contrast-agent-operator
        - name: CONTRAST_WEBHOOK_HOSTS
          value: $(CONTRAST_WEBHOOK_SERVICENAME),$(CONTRAST_WEBHOOK_SERVICENAME).$(POD_NAMESPACE).svc,$(CONTRAST_WEBHOOK_SERVICENAME).$(POD_NAMESPACE).svc.cluster.local
        - name: CONTRAST_DEFAULT_REGISTRY
          value: contrast
        - name: CONTRAST_INSTALL_SOURCE
          value: kustomize
        image: contrast/agent-operator:1.1.2
        imagePullPolicy: Always
        livenessProbe:
          httpGet:
            path: /health
            port: 5001
            scheme: HTTPS
        name: contrast-agent-operator
        ports:
        - containerPort: 5001
          name: https
        readinessProbe:
          httpGet:
            path: /ready
            port: 5001
            scheme: HTTPS
        resources:
          limits:
            cpu: 2000m
            memory: 512Mi
          requests:
            cpu: 500m
            memory: 256Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          runAsNonRoot: true
      serviceAccountName: contrast-agent-operator-service-account
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: contrast-agent-operator
  namespace: contrast-agent-operator
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: operator
      app.kubernetes.io/part-of: contrast-agent-operator
---
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  labels:
    app.kubernetes.io/name: operator
    app.kubernetes.io/part-of: contrast-agent-operator
  name: contrast-web-hook-configuration
webhooks:
- admissionReviewVersions:
  - v1
  clientConfig:
    service:
      name: contrast-agent-operator
      namespace: contrast-agent-operator
      path: /v1/pods/podmutationwebhook/mutate
  failurePolicy: Ignore
  name: pods.agents.contrastsecurity.com
  reinvocationPolicy: IfNeeded
  rules:
  - apiGroups:
    - ""
    apiVersions:
    - v1
    operations:
    - CREATE
    resources:
    - pods
    scope: Namespaced
  sideEffects: None
  timeoutSeconds: 2
